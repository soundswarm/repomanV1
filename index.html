<!--
this app:
  uses oauth to sign a user into github
  allows a user to easily create github repos
  allows a user to easily add collaborators to the repos
-->

<!DOCTYPE html>
<html lang="en" >
  <head>
    <title>github api</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <script src="js/oauth.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <link href = "css/bootstrap.min.css" rel = "stylesheet">
    <link href = "css/styles.css" rel = "stylesheet">

  </head>

  <body>
    <script>
      $(document).ready( function () {
        //oauth.io authentication
        OAuth.initialize('vMLd_AIdnpZtRPRH61n9z4j8RS8');

        //Using popup (option 1)
        //OAuth.popup('github', function(error, result) {
        OAuth.redirect('github',{cache: true}, 'http://soundswarm.github.io/repoman/index.html');
        Oauth.callback('github',function(error, result) { 
          //handle error with error
          //use result.access_token in your API request


          var apiUrl = "https://api.github.com";
          var tokenUrl ='?access_token='+result.access_token;
          var userUrl = apiUrl+'/user'+tokenUrl;
          var authRepoUrl = apiUrl+'/user/repos'+tokenUrl
          var authAddUserUrl = apiUrl+'/user/match/collaborators'+tokenUrl;     
          
          //display a string on the page
          function display(object) {
            $('.repos').hide().html(object).fadeIn();
          }; 

          //get authenticated repos
          function getRepo(callback) {
            $.ajax({
              url: authRepoUrl,
              type: 'GET',
              data: {'sort': 'updated'},
              success: function(result) {
                var repos = "";
                for (var i=0; i < result.length; i++) {
                  repos+= '<div class="list-group-item"> <a href='+result[i].html_url+' class="btn btn-primary">'+result[i].name+ '</a> <label class="btn btn-primary"> <input type="checkbox" id='+ result[i].name+'> Add collaborator </label></div>';
                  callback(repos);
                }
              }
            });
          }
          getRepo(display);

          //when create button is clicked, create a new repo and display it
          $(".create").on('click', function() {
            event.preventDefault();            
            $.ajax(authRepoUrl, {
              type: 'POST',
              data: JSON.stringify({
                "name": $('.repoName').val()
              }),
              success: function(result) {
                console.log(result);
                $('.repos').prepend('<div class="list-group-item"> <a href='+result.html_url+' class="btn btn-primary">'+result.name+ '</a> <label class="btn btn-primary"> <input type="checkbox" id='+ result.name+'> add collaborator </label></div>');
              }
            });
          });
     
          //add collaborator to repo(s) function
          function addCollaborator(userAdded, repo) {
            $.get(userUrl, function(user) {
              var addUserUrl = apiUrl+'/repos/'+user.login+'/'+repo+'/collaborators/'+userAdded+tokenUrl;
              $.ajax({
                url: addUserUrl,
                type: 'PUT',
                success:  function(response) {
                  console.log(response);
                  $.get(apiUrl+'/users/'+userAdded, function(response) {
                    $('#'+repo).closest('.list-group-item').children('img').hide();
                    $('#'+repo).closest('.list-group-item').append('<img src='+response.avatar_url+' class="img-responsive img-circle" alt="user added">');
                  });
                }
              });
            });
          };

          //when add button is clicked, add new user to repos
          $('.add').on('click', function() {
            event.preventDefault();
            var repos = $("input[type=checkbox]:checked");
            if(repos.length == 0) {
              $('.error').hide();
              $('#userName').append('<div class="error">check the repos to which you want to add a user</div>').fadeIn();
            } else {
              for(var i=0; i<repos.length; i++) {
                $('.error').hide();
                addCollaborator($('.userName').val(), repos[i].id);
              }
            }
              
          }); 
        });
      }); 
    </script>
       
    <!--create repo -->
    <h3>Create a new Github repository</h3>

    <form class="form-inline" role="form" id="repoName">
      <div class="form-group">
        <input type="text" class="form-control repoName" placeholder="new repo's name">
      </div>
      <button type="submit" class="btn btn-primary create">create</button>
    </form>

    <!--add user-->
    <h3>Add a colaborator to Github repos</h3>
    <form class="form-inline" role="form" id="userName">
      <div class="form-group">
        <input type="text" class="form-control userName" placeholder="collaborator's username">
      </div>
      <button type="submit" class="btn btn-primary add">add</button>
    </form>

  <!--list all repos-->
    <h3>Repos</h3>
    <div class="list-group repos"></div>

  </body>
</html>
